name: Convert Modules Simply

on:
  schedule:
    - cron: '0 0 * * *' # 每天执行一次
  workflow_dispatch: # 手动触发

jobs:
  update-snippet:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download Modules-Links.txt
      run: |
        curl -L -o Modules-Links.txt https://path/to/Modules-Links.txt

    - name: Download and Convert snippets
      run: |
        mkdir -p Original Modules/Surge Modules/Loon
        while IFS= read -r line; do
          # 提取 URL 和文件名
          url=$(echo $line | awk '{print $1}')
          filename=$(basename "$url")
          author=$(echo $url | awk -F'/' '{print $(NF-2)}')
          module_name=$(echo $filename | sed 's/\.[^\.]*$//')
          
          # 下载文件
          curl -L -o "Original/$filename" "$url"

          # 提取注释内容
          hostnames=$(grep -v '^#' "Original/$filename" | grep 'hostname = ' | awk -F'hostname = ' '{print $2}' | tr '\n' ', ' | sed 's/, $//')
          comment="# ${module_name} // ${hostnames}"
          
          # 转换文件
          bash Convert-Modules-827.sh "Original/$filename" "${author}_${module_name}" "$comment"
        done < Modules-Links.txt

    - name: Create README in Modules directory
      run: |
        echo "# Modules for Surge and Loon" > Modules/README.md
        echo "" >> Modules/README.md
        echo "This directory contains converted modules from various sources, compatible with Surge and Loon." >> Modules/README.md
        echo "" >> Modules/README.md
        echo "## Sources" >> Modules/README.md
        echo "" >> Modules/README.md

        while IFS= read -r line; do
          url=$(echo $line | awk '{print $1}')
          filename=$(basename "$url")
          module_name=$(echo $filename | sed 's/\.[^\.]*$//')
          author=$(echo $url | awk -F'/' '{print $(NF-2)}')
          echo "- **${module_name}**: Converted from [${author} ${filename}](https://github.com/${author}/repo/raw/master/${filename})" >> Modules/README.md
        done < Modules-Links.txt

    - name: Commit and Push changes
      run: |
        git config --local user.name "ifflagged"
        git config --local user.email "qibo.sign@outlook.com"
        git add .
        if git diff --cached --quiet; then
          echo "No changes detected"
        else
          git commit -m "Update Modules"
          git push
        fi

    - name: Send TG Notification
      run: |
        # Check if there is a previous commit
        if git rev-parse --verify HEAD^1 >/dev/null 2>&1; then
          UPDATED_FILES=$(git diff --name-only HEAD^1 HEAD Modules/)
        else
          UPDATED_FILES=$(git diff --name-only HEAD Modules/)
        fi
        
        if [ -n "$UPDATED_FILES" ]; then
          MESSAGE="The following files have been updated:\n$UPDATED_FILES"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage -d chat_id=${{ secrets.TG_ID }} -d text="$MESSAGE"
        else
          echo "No files were updated, no notification sent."
        fi
