name: Convert Modules

on:
  schedule:
    - cron: '0 0 * * *' # 每天执行一次
  workflow_dispatch: # 手动触发

jobs:
  update-snippet:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download snippets and prepare variables
      id: download-and-prepare
      run: |
        mkdir -p Original
        README_CONTENT=""
        FILES_LIST=""
        while read -r url; do
          # 提取作者名称和文件名
          author=$(echo "$url" | awk -F'/' '{print $4}')
          filename=$(basename "$url")
          filename_no_ext=$(basename "$url" | cut -d'.' -f1)
          # 创建作者文件夹
          mkdir -p "Original/$author"
          # 下载文件
          file_path="Original/$author/$filename"
          curl -L -o "$file_path" "$url"
          
          # 准备README内容
          README_CONTENT="${README_CONTENT}\n- **${filename_no_ext}**: Converted from ${url}"
          FILES_LIST="${FILES_LIST}\n${filename_no_ext}"
        done < Links/Modules-Links.txt
        echo -e "$README_CONTENT" > Modules/README.md
        echo -e "$FILES_LIST" > files_list.txt

    - name: Run Convert Modules script
      run: |
        while read -r filename; do
          Scripts/Convert-Modules.sh "Original/${filename}.txt" "${filename}"
        done < files_list.txt

    - name: Commit changes
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add Modules/*
        git commit -m "Update modules"
        git push
