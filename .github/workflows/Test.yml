name: Rewrite Parser

on:
  workflow_dispatch:  # 允许手动触发工作流
  pull_request:

jobs:
  analyze_links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Read Links from file
        id: read_links
        run: |
          file="Links/Modules-Links.txt"
          links=()
          while IFS= read -r line; do
            links+=("$line")
          done < "$file"
          echo "links=${links[*]}" >> $GITHUB_ENV

      - name: Generate URLs
        id: generate_urls
        run: |
          urls=()
          IFS=' ' read -r -a links <<< "$links"
          for link in "${links[@]}"; do
            filename=$(basename "$link")
            extension="${filename##*.}"
            filename_no_ext="${filename%.*}"

            if [[ "$extension" == "sgmodule" ]]; then
              type="surge-module"
            elif [[ "$extension" == "plugin" ]]; then
              type="loon-plugin"
            else
              type="qx-rewrite"
            fi

            url="http://script.hub/file/_start_/${link}_end_/${filename}?type=${type}&target=${type}"
            urls+=("$url")
          done
          echo "urls=${urls[*]}" >> $GITHUB_ENV

      - name: Process URLs
        run: |
          for url in ${{ env.urls }}; do
            curl -X POST -H "Content-Type: application/json" \
            -d "{\"url\": \"$url\"}" \
            https://raw.githubusercontent.com/Script-Hub-Org/Script-Hub/main/Rewrite-Parser.js
          done
