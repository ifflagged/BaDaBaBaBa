name: Process Links

on:
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  process_links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Read links and generate new links
        id: generate_links
        run: |
          file="Links/Modules-Links.txt"
          output="Links/Processed-Links.txt"
          echo "" > $output

          while IFS= read -r line; do
            filename=$(basename "$line")
            extension="${filename##*.}"
            base="${filename%.*}"

            # 根据文件后缀设置type
            if [[ "$extension" == "sgmodule" ]]; then
              type="surge-module"
            elif [[ "$extension" == "plugin" ]]; then
              type="loon-plugin"
            else
              type="qx-rewrite"
            fi

            # 生成新链接
            new_link="http://script.hub/file/_start_/$line/_end_/$filename?type=$type&target=$type"
            echo "$new_link" >> $output
          done < "$file"

      - name: Fetch Rewrite-Parser.js
        run: |
          curl -O https://raw.githubusercontent.com/Script-Hub-Org/Script-Hub/main/Rewrite-Parser.js

      - name: Run Rewrite-Parser.js
        run: |
          node -e "const fs = require('fs'); const { execSync } = require('child_process'); execSync('node Rewrite-Parser.js', { stdio: 'inherit' })"
